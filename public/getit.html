 <!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GetIt ‚Äì Live Subtitles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; background:#000; color:#fff; }
    .wrap { display:flex; align-items:center; justify-content:center; height:100%; padding: 2rem; }
    .box { max-width: 1200px; font: 700 48px/1.2 system-ui, sans-serif; }
    .partial { opacity: 0.6; }
    .final { opacity: 1; }
  </style>
</head>
<body>
  <div class="wrap"><div class="box" id="out">Waiting‚Ä¶</div></div>
<script>
const out = document.getElementById('out');
let pending = '';
let lastFinal = [];
let ws = null;
let reconnectTimer = null;

function connect() {
  console.log('üîå Verbinde WebSocket...');
  const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/subs';
  console.log('URL:', wsUrl);
  
  ws = new WebSocket(wsUrl);
  
  ws.onopen = () => {
    console.log('‚úÖ WebSocket verbunden!');
    out.textContent = 'Verbunden ‚Äì warte auf Untertitel...';
    out.style.color = '#fff';
    
    // Sende Ping alle 30 Sekunden um Verbindung am Leben zu halten
    if (reconnectTimer) clearInterval(reconnectTimer);
    reconnectTimer = setInterval(() => {
      if (ws && ws.readyState === 1) {
        console.log('üíì Ping...');
      }
    }, 30000);
  };

  ws.onerror = (err) => {
    console.error('‚ùå WebSocket Fehler:', err);
    out.textContent = 'Verbindungsfehler!';
    out.style.color = '#f00';
  };

  ws.onclose = (e) => {
    console.log('‚ùå WebSocket geschlossen. Code:', e.code, 'Reason:', e.reason);
    out.textContent = 'Verbindung getrennt - versuche Reconnect...';
    out.style.color = '#fa0';
    
    if (reconnectTimer) clearInterval(reconnectTimer);
    
    // Auto-Reconnect nach 2 Sekunden
    console.log('‚è≥ Reconnect in 2 Sekunden...');
    setTimeout(connect, 2000);
  };

  ws.onmessage = (m) => {
    try {
      console.log('üì© Rohdaten empfangen:', m.data);
      const ev = JSON.parse(m.data);
      console.log('üìù Geparst:', ev);
      
      if (ev.type === 'partial') {
        pending = ev.text;
        const display = lastFinal.length > 0 
          ? `<span class="final">${lastFinal.join(' ')}</span> <span class="partial">${pending}</span>`
          : `<span class="partial">${pending}</span>`;
        out.innerHTML = display;
        console.log('‚úì Partial angezeigt:', pending);
      } else if (ev.type === 'final') {
        lastFinal.push(ev.text);
        if (lastFinal.length > 8) lastFinal.shift();
        pending = '';
        out.innerHTML = `<span class="final">${lastFinal.join(' ')}</span>`;
        console.log('‚úì Final angezeigt:', ev.text);
      }
    } catch (err) {
      console.error('‚ùå Fehler beim Parsen:', err, 'Rohdaten:', m.data);
    }
  };
}

// Initial-Verbindung
connect();
</script>
</body>
</html>
